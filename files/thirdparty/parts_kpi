#!/bin/bash

set -e

#export https_proxy="squid.internal:3128"

PUSH_BASE_URL="http://push.snappy.kpi.internal:9091"

PARTS_STATUS=$(curl -s https://parts.snapcraft.io/v1/status)

METRICS=$(cat <<EOF
# TYPE total_parts counter
total_parts{metric_type="kpi"} $(echo "$PARTS_STATUS" | grep 'part-count' | cut -d' ' -f2)
EOF
)

echo "$METRICS" | curl -s --data-binary @- $PUSH_BASE_URL/metrics/job/parts_kpi

echo "PUSHED $(date)"
